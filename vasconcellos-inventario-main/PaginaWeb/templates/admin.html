{% extends "base.html" %}
{% block title %}Panel de Control{% endblock %}
{% block content %}
  <h2 class="page-title">Gestionar Inventario</h2>

  <div class="card form-card mb-8" style="padding:24px;">
    <h3 class="text-xl font-semibold mb-4" style="margin-top:0;">Añadir/Editar Producto</h3>
    <p class="text-gray-400" style="margin-top:-6px;margin-bottom:18px;">
      Consejo: usa imágenes 800×600 para mejor look.
    </p>

    <form id="product-form" action="{{ url_for('add_product') }}" method="POST"
          class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" name="product_id" id="product_id">

      <div class="form-group">
        <label for="name">Nombre</label>
        <input type="text" name="name" id="name" required class="input-field">
      </div>

      <div class="form-group">
        <label for="price">Precio</label>
        <input type="number" name="price" id="price" step="0.01" required class="input-field">
      </div>

      <div class="form-group md:col-span-2">
        <label for="image_url">URL Imagen</label>
        <input type="url" name="image_url" id="image_url" placeholder="https://..." class="input-field">
      </div>

      <div class="form-group md:col-span-2">
        <label for="description">Descripción / Consejos</label>
        <textarea name="description" id="description" rows="3" class="input-field"></textarea>
      </div>

      <div class="md:col-span-2" style="display:flex;justify-content:flex-end;gap:8px">
        <button type="submit" class="btn btn-primary">Guardar Producto</button>
        <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">
          Cancelar Edición
        </button>
      </div>
    </form>
  </div>

  <div class="card" style="padding:18px;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;">
      <h3 class="text-xl font-semibold">Inventario Actual</h3>
      <button id="export-csv" class="btn btn-secondary">Exportar CSV</button>
    </div>
    <div class="overflow-x-auto">
      <table class="inventory-table" id="inventory-table">
        <thead>
          <tr>
            <th>Imagen</th><th>Nombre</th><th>Precio</th><th>Descripción</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr id="product-row-{{ product.id }}">
            <td><img src="{{ product.image_url }}" alt="{{ product.name }}" class="table-img" loading="lazy"></td>
            <td>{{ product.name }}</td>
            <td>${{ "%.2f"|format(product.price) }}</td>
            <td class="description-cell">{{ product.description }}</td>
            <td class="action-buttons">
              <button class="btn-sm btn-secondary edit-product-btn"
                      data-id="{{ product.id }}"
                      data-name="{{ product.name }}"
                      data-price="{{ product.price }}"
                      data-image="{{ product.image_url }}"
                      data-description="{{ product.description }}">
                Editar
              </button>
              <form action="{{ url_for('delete_product', product_id=product.id) }}"
                    method="POST" style="display:inline;"
                    onsubmit="return confirm('¿Seguro que quieres eliminar este producto?');">
                <button type="submit" class="btn-sm btn-danger">Eliminar</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-8">Inventario vacío.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Rellenar formulario al pulsar "Editar"
    document.querySelectorAll('.edit-product-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const form = document.getElementById('product-form');
        form.action = `/edit/${btn.dataset.id}`;
        document.getElementById('product_id').value = btn.dataset.id;
        document.getElementById('name').value = btn.dataset.name;
        document.getElementById('price').value = btn.dataset.price;
        document.getElementById('image_url').value = btn.dataset.image;
        document.getElementById('description').value = btn.dataset.description;
        document.getElementById('cancel-edit-btn').style.display = 'inline-block';
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // Cancelar edición
    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
      const form = document.getElementById('product-form');
      form.action = "{{ url_for('add_product') }}";
      form.reset();
      document.getElementById('product_id').value = '';
      document.getElementById('cancel-edit-btn').style.display = 'none';
    });

    // Exportar CSV (cliente)
    document.getElementById('export-csv').addEventListener('click', () => {
      const rows = [...document.querySelectorAll('#inventory-table tbody tr')];
      const data = [['Nombre','Precio','Descripcion','Imagen']];
      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= 4) {
          const img = tds[0].querySelector('img')?.src || '';
          const name = tds[1].textContent.trim();
          const price = tds[2].textContent.replace('$','').trim();
          const desc = tds[3].textContent.replace(/\s+/g,' ').trim();
          data.push([name, price, desc, img]);
        }
      });
      const csv = data.map(r => r.map(v => `"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'inventario.csv'; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
{% endblock %}
